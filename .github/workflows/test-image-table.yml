on: workflow_dispatch

jobs:
  test-image-table:
    runs-on: ubuntu-20.04
    env:
      TEST_COUNT: 2
      PAGE_SIZE: 100
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install -g simple-statistics
          cd playwright
          make deps

      - name: Download previous run results
        uses: actions/github-script@v6
        continue-on-error: true
        env:
          ARTIFACT_NAME: test-image-table-report
          ARTIFACT_FILENAME: test-image-table-report.zip
        with:
          script: |
            const script = require('./.github/scripts/download-prev-test-image-table-artifact.js')
            await script({github, context, core})

      - name: Run the test
        run: |
          cd playwright
          npx playwright test image.spec.ts

      - name: Create the summary
        uses: actions/github-script@v6
        continue-on-error: true
        with:
          script: |
              const script = require('./.github/scripts/test-image-table-summary.js')
              await script({core})

      - name: Upload the test result
        uses: actions/upload-artifact@v4
        with:
          name: test-image-table-report
          path: playwright/test-report.json
          retention-days: 30
